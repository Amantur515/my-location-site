<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–õ–æ–∫–∞—Ç–æ—Ä+ ‚Äî —á—Ç–æ —Ä—è–¥–æ–º?</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet/dist/leaflet.css"
/>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f2f2f2;
    margin: 0;
    padding: 20px;
    text-align: center;
  }
  h1 {
    color: #2c3e50;
  }
  #map {
    height: 450px;
    width: 100%;
    max-width: 700px;
    margin: 20px auto;
    border-radius: 12px;
    box-shadow: 0 0 12px rgba(0, 0, 0, 0.2);
  }
  #info {
    font-size: 16px;
    margin-top: 10px;
    min-height: 20px;
  }
  button {
    background-color: #007bff;
    color: white;
    padding: 10px 22px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover {
    background-color: #0056b3;
  }
  #places {
    margin-top: 15px;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
    text-align: left;
  }
  #places h2 {
    color: #34495e;
  }
  #places ul {
    list-style: none;
    padding-left: 0;
  }
  #places li {
    margin-bottom: 6px;
  }
  #weather {
    margin-top: 15px;
    font-size: 18px;
    color: #2c3e50;
  }
</style>
</head>
<body>

<h1>–õ–æ–∫–∞—Ç–æ—Ä+ ‚Äî —á—Ç–æ —Ä—è–¥–æ–º?</h1>
<button onclick="locateAndShow()">üîç –ù–∞–π—Ç–∏ –º–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—Å—ë —Ä—è–¥–æ–º</button>
<div id="info">–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
<div id="map"></div>
<div id="places"></div>
<div id="weather"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let map, marker;

  function locateAndShow() {
    if (!navigator.geolocation) {
      document.getElementById("info").innerText =
        "‚ö†Ô∏è –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.";
      return;
    }

    document.getElementById("info").innerText = "‚åõ –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ...";

    navigator.geolocation.getCurrentPosition(
      async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        document.getElementById("info").innerText = `üìç –í–∞—à–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat.toFixed(
          6
        )}, ${lon.toFixed(6)}`;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        if (!map) {
          map = L.map("map").setView([lat, lon], 15);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors",
          }).addTo(map);
          marker = L.marker([lat, lon]).addTo(map).bindPopup("–í—ã –∑–¥–µ—Å—å").openPopup();
        } else {
          map.setView([lat, lon], 15);
          marker.setLatLng([lat, lon]);
        }

        // –ü–æ–ª—É—á–∞–µ–º –º–µ—Å—Ç–∞ —Ä—è–¥–æ–º (–º–∞–≥–∞–∑–∏–Ω—ã, –∫–∞—Ñ–µ, –±–æ–ª—å–Ω–∏—Ü—ã)
        document.getElementById("places").innerHTML = "<h2>üîé –ú–µ—Å—Ç–∞ —Ä—è–¥–æ–º:</h2><p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>";

        const places = await fetchNearbyPlaces(lat, lon);
        showPlaces(places);

        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É
        document.getElementById("weather").innerHTML = "<p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥—ã...</p>";
        fetchWeather(lat, lon);
      },
      (err) => {
        let msg = "";
        switch (err.code) {
          case err.PERMISSION_DENIED:
            msg = "‚ùå –î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â—ë–Ω.";
            break;
          case err.POSITION_UNAVAILABLE:
            msg = "‚ö†Ô∏è –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.";
            break;
          case err.TIMEOUT:
            msg = "‚è≥ –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ.";
            break;
          default:
            msg = "‚ùó –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.";
        }
        document.getElementById("info").innerText = msg;
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  }

  async function fetchNearbyPlaces(lat, lon) {
    // Overpass API –∑–∞–ø—Ä–æ—Å: –º–∞–≥–∞–∑–∏–Ω—ã, –∫–∞—Ñ–µ, –±–æ–ª—å–Ω–∏—Ü—ã, –∞–ø—Ç–µ–∫–∏
    const query = `
      [out:json][timeout:25];
      (
        node["shop"](around:1000,${lat},${lon});
        node["amenity"="cafe"](around:1000,${lat},${lon});
        node["amenity"="restaurant"](around:1000,${lat},${lon});
        node["amenity"="hospital"](around:1000,${lat},${lon});
        node["amenity"="pharmacy"](around:1000,${lat},${lon});
      );
      out body;
    `;

    const url = "https://overpass-api.de/api/interpreter";

    try {
      const response = await fetch(url, {
        method: "POST",
        body: query,
        headers: {
          "Content-Type": "text/plain",
        },
      });
      const data = await response.json();
      return data.elements;
    } catch (e) {
      return [];
    }
  }

  function showPlaces(places) {
    if (!places || places.length === 0) {
      document.getElementById("places").innerHTML =
        "<h2>üîé –ú–µ—Å—Ç–∞ —Ä—è–¥–æ–º:</h2><p>–ú–µ—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</p>";
      return;
    }

    // –°–≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ç–∏–ø—É
    const grouped = {};
    for (const p of places) {
      const type = p.tags.shop || p.tags.amenity || "–î—Ä—É–≥–æ–µ";
      if (!grouped[type]) grouped[type] = [];
      grouped[type].push(p);
    }

    let html = "<h2>üîé –ú–µ—Å—Ç–∞ —Ä—è–¥–æ–º:</h2>";

    for (const [type, items] of Object.entries(grouped)) {
      html += `<h3>${type.charAt(0).toUpperCase() + type.slice(1)} (${items.length})</h3><ul>`;
      for (const place of items) {
        const name = place.tags.name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
        html += `<li>${name}</li>`;
      }
      html += "</ul>";
    }

    document.getElementById("places").innerHTML = html;
  }

  async function fetchWeather(lat, lon) {
    // Open-Meteo –±–µ–∑ API –∫–ª—é—á–∞, —Å —Ç–µ–∫—É—â–µ–π –ø–æ–≥–æ–¥–æ–π
    try {
      const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`;
      const res = await fetch(weatherUrl);
      const weather = await res.json();

      if (weather.current_weather) {
        const w = weather.current_weather;
        const weatherHtml = `
          <h2>üå¶Ô∏è –¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞:</h2>
          <p>–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${w.temperature}¬∞C</p>
          <p>–í–µ—Ç–µ—Ä: ${w.windspeed} –∫–º/—á</p>
          <p>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞: ${w.winddirection}¬∞</p>
          <p>–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(w.time).toLocaleTimeString()}</p>
        `;
        document.getElementById("weather").innerHTML = weatherHtml;
      } else {
        document.getElementById("weather").innerHTML = "<p>–ü–æ–≥–æ–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.</p>";
      }
    } catch (e) {
      document.getElementById("weather").innerHTML = "<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–≥–æ–¥—ã.</p>";
    }
  }
</script>

</body>
</html>
